#!/usr/sbin/nft -f

flush ruleset

# =============================
# üîí FIREWALL - FILTRO DE PAQUETES
# =============================

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Conexiones establecidas o relacionadas
    ct state established,related accept

    # Loopback
    iif "lo" accept

    # ICMP (ping)
    ip protocol icmp accept

    # DNS externo/local
    ip protocol udp udp dport 53 accept
    ip protocol tcp tcp dport 53 accept
    ip protocol udp udp sport 53 accept
    ip protocol tcp tcp sport 53 accept

    # NTP
    udp dport 123 accept

    # Bridges internos (incluye OKD SNO)
    iifname { "br0", "virbr0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } accept

    # -----------------------------
    # üîê Infra-cluster (VM infra)
    # -----------------------------
    ip daddr 192.168.0.30 tcp dport { 80, 443, 8080, 8443 } accept
    ip saddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24, 192.168.0.0/24 } ip daddr 192.168.0.30 accept

    # API K8s (VIP)
    ip daddr 192.168.0.32 tcp dport 6443 accept

    # Traefik/LB
    ip daddr 192.168.0.33 tcp dport { 80, 443, 30807, 32389, 31541 } accept

    # -----------------------------
    # üåê Puertos OKD / Kubernetes
    # -----------------------------
    tcp dport {
      6443,      # API server OKD
      22623      # Machine Config Server
    } accept

    # Puertos generales (incluye NodePorts)
    tcp dport {
      22, 80, 443, 6443, 22623,
      8080, 8081, 8082, 8443,
      9090, 9091, 9093, 9100,
      3000,
      30807,
      30000-32767,
      32000-32767
    } accept

    # Worker3 acceso extendido
    ip saddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24, 192.168.0.0/24 } ip daddr 10.17.4.26 tcp dport { 80, 443, 31541 } accept
    ip saddr 10.17.4.26 ip daddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24, 192.168.0.0/24 } tcp sport { 80, 443, 31541 } accept

    # NodePorts locales
    ip saddr 127.0.0.1 tcp dport { 80, 443, 31541, 32591 } accept

    # RDP
    tcp dport 3389 accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    # Conexiones establecidas
    ct state established,related accept

    # Tr√°fico interno entre redes internas existentes
    ip saddr 10.17.0.0/16 ip daddr 10.17.0.0/16 accept
    ip saddr 192.168.0.0/24 ip daddr 10.17.0.0/16 accept
    ip saddr 10.17.0.0/16 ip daddr 192.168.0.0/24 accept

    # -----------------------------
    # üåê Red OKD multinodo (10.56.0.0/24)
    # -----------------------------
    ip saddr 10.56.0.0/24 ip daddr 10.56.0.0/24 accept
    ip saddr 192.168.0.0/24 ip daddr 10.56.0.0/24 accept
    ip saddr 10.56.0.0/24 ip daddr 192.168.0.0/24 accept

    # -----------------------------
    # üåê Red OKD SNO (10.66.0.0/24)
    # -----------------------------
    ip saddr 10.66.0.0/24 ip daddr 10.66.0.0/24 accept
    ip saddr 192.168.0.0/24 ip daddr 10.66.0.0/24 accept
    ip saddr 10.66.0.0/24 ip daddr 192.168.0.0/24 accept

    # API VIP
    ip saddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24 } ip daddr 192.168.0.32 tcp dport 6443 accept
    ip saddr 192.168.0.32 ip daddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24 } tcp sport 6443 accept

    # Traefik/LB
    ip saddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24 } ip daddr 192.168.0.33 tcp dport { 80, 443, 30807, 31541 } accept
    ip saddr 192.168.0.33 ip daddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24 } tcp sport { 80, 443, 30807, 31541 } accept

    # Bridges internos con OKD SNO a√±adido
    iifname { "br0", "virbr0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } \
    oifname { "br0", "virbr0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } accept

    oifname { "br0", "virbr0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } \
    iifname { "br0", "virbr0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } accept

    # Salida a Internet desde bridges internos (incluye virbr-sno)
    iifname { "br0", "virbr_kube02", "virbr_kube03", "virbr_okd", "virbr-sno" } oifname "enp3s0f0" accept
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}

# =============================
# üåê NAT: Salida de Internet
# =============================

table inet nat {
  chain postrouting {
    type nat hook postrouting priority srcnat; policy accept;

    # NAT redes internas + OKD multinodo + OKD SNO
    ip saddr { 10.17.3.0/24, 10.17.4.0/24, 10.56.0.0/24, 10.66.0.0/24, 192.168.0.0/24 } oifname "enp3s0f0" masquerade
  }
}

# =============================
# üß™ LIBVIRT - Permitir todo
# =============================

table ip libvirt_network {
  chain forward {
    counter accept
  }

  chain guest_input {
    counter accept
  }

  chain guest_output {
    counter accept
  }

  chain guest_cross {
    counter accept
  }

  chain guest_nat {
    counter accept
  }
}